#!/usr/bin/env Rscript
source('common.r')

# j <- '{ "0": 33729, "10": 31, "20": 25, "30": 26, "40": 18, "50": 14, "60": 14, "70": 17, "80": 18, "90": 22, "100": 10, "110": 18, "120": 16, "130": 11, "140": 10, "150": 2, "160": 13, "170": 10, "180": 14, "190": 9, "200": 10, "210": 9, "220": 13, "230": 10, "240": 15, "250": 9, "260": 6, "270": 5, "280": 8, "290": 9, "300": 10, "310": 5, "320": 10, "330": 11, "340": 11, "350": 5, "360": 7, "370": 3, "380": 5, "390": 9, "400": 6, "410": 4, "420": 6, "430": 9, "440": 10, "450": 10, "460": 2, "470": 8, "480": 6, "490": 5, "500": 7, "510": 7, "520": 4, "530": 6, "540": 1, "550": 6, "560": 5, "570": 5, "580": 5, "590": 3, "600": 1, "610": 4, "620": 3, "630": 2, "650": 3, "680": 6, "690": 5, "700": 2, "710": 1, "720": 2, "730": 1, "740": 7, "760": 3, "770": 2, "780": 5, "790": 6, "810": 6, "820": 4, "830": 3, "840": 1, "850": 1, "860": 1, "870": 4, "880": 1, "890": 1, "900": 3, "910": 2, "920": 1, "930": 1, "940": 2, "950": 4, "960": 1, "980": 4, "990": 2, "1000": 2, "1010": 5, "1020": 1, "1030": 3, "1050": 1, "1090": 3, "1110": 5, "1140": 1, "1150": 4, "1160": 1, "1180": 3, "1190": 2, "1200": 2, "1210": 2, "1220": 1, "1230": 1, "1250": 2, "1290": 1, "1300": 1, "1310": 1, "1320": 1, "1340": 2, "1350": 1, "1360": 1, "1390": 1, "1400": 2, "1410": 1, "1430": 1, "1440": 1, "1450": 1, "1470": 1, "1480": 1, "1490": 1, "1500": 2, "1510": 1, "1520": 1, "1560": 1, "1580": 1, "1640": 1, "1710": 1, "1720": 1, "1730": 1, "1770": 1, "1780": 1, "1790": 1, "1800": 1, "1810": 2, "1820": 1, "1840": 1, "2070": 2, "2100": 1, "2120": 1, "2200": 1, "2390": 1, "2430": 1, "2510": 1, "2530": 1, "2630": 1, "2890": 1, "3020": 1, "3240": 1, "3360": 1 }'

# j <- '{ "0": 29015, "10": 2495, "20": 425, "30": 246, "40": 165, "50": 187, "60": 135, "70": 139, "80": 120, "90": 124, "100": 96, "110": 81, "120": 63, "130": 64, "140": 65, "150": 67, "160": 48, "170": 47, "180": 27, "190": 38, "200": 27, "210": 35, "220": 19, "230": 17, "240": 14, "250": 20, "260": 8, "270": 14, "280": 8, "290": 5, "300": 7, "310": 7, "320": 7, "330": 15, "340": 7, "350": 5, "360": 7, "370": 2, "380": 5, "390": 1, "400": 3, "410": 3, "420": 3, "430": 2, "440": 1, "450": 1, "460": 3, "470": 1, "500": 1, "510": 1, "520": 1, "530": 1, "540": 1, "560": 1, "570": 1 }'

# nbids
# j <- '{ "0": 20855, "10": 7665, "20": 3279, "30": 1321, "40": 538, "50": 225, "60": 103, "70": 39, "80": 16, "90": 8, "100": 6, "110": 2, "120": 1, "130": 2, "150": 2, "160": 4, "180": 2, "240": 1, "270": 1, "280": 1, "310": 1 }'

# auction duration:
# j <- jsfix("{'15600': 194, '4300': 63, '16600': 198, '9200': 126, '15900': 206, '3100': 51, '13400': 155, '8300': 122, '11300': 119, '1300': 16, '10100': 137, '5500': 76, '7300': 104, '15200': 216, '6000': 70, '4700': 62, '4900': 73, '12400': 160, '0': 7, '5900': 73, '13000': 150, '2400': 32, '400': 14, '19700': 278, '11700': 135, '8900': 131, '19400': 243, '14100': 167, '2700': 47, '3400': 44, '10200': 137, '9700': 124, '16300': 194, '15500': 192, '18000': 210, '17400': 225, '1700': 18, '13600': 168, '18800': 248, '14500': 174, '9900': 112, '4100': 71, '5300': 77, '11100': 151, '3200': 25, '4400': 57, '7600': 99, '19300': 243, '11900': 151, '8700': 116, '2600': 35, '12300': 153, '10800': 164, '2900': 32, '9600': 121, '19200': 230, '8600': 106, '11800': 130, '700': 12, '12900': 176, '11200': 126, '5600': 75, '17700': 219, '17000': 218, '17900': 214, '6700': 86, '4200': 52, '9300': 127, '16700': 220, '15100': 203, '4800': 66, '12500': 150, '2300': 35, '13300': 182, '10600': 144, '8800': 133, '11600': 138, '18400': 215, '1400': 25, '6300': 102, '5000': 67, '13900': 186, '300': 12, '10700': 149, '19900': 287, '19600': 241, '8200': 93, '15400': 188, '18100': 226, '16400': 215, '9000': 113, '7900': 99, '100': 15, '14600': 214, '900': 14, '11000': 160, '7700': 96, '5400': 81, '3500': 47, '6500': 81, '12000': 154, '17300': 236, '10900': 123, '18900': 246, '1000': 24, '8500': 96, '19500': 248, '18600': 228, '17200': 210, '3800': 58, '10300': 149, '6600': 111, '17800': 231, '14300': 184, '3000': 49, '15000': 181, '3900': 41, '2800': 41, '1900': 36, '2200': 42, '13200': 172, '16800': 232, '5700': 76, '16000': 204, '11500': 168, '18500': 229, '1500': 33, '9400': 118, '6200': 85, '500': 22, '15800': 189, '10400': 140, '3600': 47, '8100': 126, '9500': 127, '16100': 230, '6800': 88, '17600': 239, '14700': 170, '7000': 83, '5100': 74, '13800': 168, '4600': 59, '19100': 252, '12100': 168, '18200': 209, '1800': 30, '1100': 23, '2100': 40, '7400': 108, '17100': 224, '18700': 222, '10000': 135, '600': 19, '7800': 108, '15700': 188, '6900': 80, '1200': 32, '9100': 117, '16500': 196, '8400': 106, '13500': 168, '14200': 185, '16900': 215, '11400': 152, '4000': 72, '7200': 109, '15300': 199, '6100': 73, '14800': 185, '3300': 47, '5800': 81, '13100': 155, '2500': 29, '16200': 216, '200': 12, '17500': 213, '18300': 243, '14000': 189, '14900': 172, '7100': 108, '5200': 75, '19800': 249, '4500': 81, '12800': 163, '12600': 166, '10500': 129, '3700': 62, '8000': 134, '6400': 76, '800': 26, '12700': 167, '1600': 36, '13700': 169, '14400': 173, '9800': 133, '2000': 28, '7500': 98, '19000': 217, '12200': 154}")

# bid time hist:
# j <- jsfix("{'0.9': 18162, '0.8': 12692, '0.34': 2430, '1.1': 220, '0.74': 9873, '0.1': 1070, '0.3': 2005, '0.2': 1439, '0.5': 4499, '0.4': 2857, '0.7': 8767, '0.6': 6106, '0.68': 8089, '0.62': 6617, '0.64': 6941, '0.22': 1652, '0.48': 4159, '0.46': 3829, '0.44': 3510, '0.42': 3278, '0.08': 1073, '0.78': 11787, '0.28': 1960, '0.02': 795, '0.26': 1798, '0.06': 961, '0.04': 886, '0.18': 1411, '0.82': 13485, '0': 964, '0.86': 15900, '0.84': 14689, '0.88': 16976, '0.14': 1259, '0.16': 1315, '0.76': 10858, '0.66': 7510, '0.12': 1206, '0.52': 4831, '0.54': 4924, '0.56': 5427, '0.72': 9343, '0.36': 2563, '0.38': 2717, '0.32': 2229, '0.24': 1773, '0.98': 17546, '0.58': 5909, '0.94': 19210, '0.96': 18983, '0.92': 19206}")

# bid time hist (bidspread=20k)
# j <- jsfix("{'0.9': 11356, '0.8': 9621, '0.34': 4989, '1.1': 124, '0.74': 8686, '0.1': 4086, '0.3': 4638, '0.2': 4258, '0.5': 5982, '0.4': 5273, '0.7': 8083, '0.6': 6929, '0.68': 7745, '0.62': 7189, '0.64': 7465, '0.22': 4224, '0.48': 5807, '0.46': 5599, '0.44': 5348, '0.42': 5419, '0.08': 4131, '0.78': 9159, '0.28': 4520, '0.02': 3973, '0.26': 4291, '0.06': 4136, '0.04': 4345, '0.18': 4075, '0.82': 9934, '0': 4638, '0.86': 10903, '0.84': 10423, '0.88': 11104, '0.14': 4084, '0.16': 4046, '0.76': 9028, '0.66': 7566, '0.12': 4107, '0.52': 6069, '0.54': 6482, '0.56': 6376, '0.72': 8374, '0.36': 4880, '0.38': 5047, '0.32': 4814, '0.24': 4360, '0.98': 8802, '0.58': 6609, '0.94': 11208, '0.96': 10123, '0.92': 11614}")

# bid time hist (bidspread=5k)
# j <- jsfix("{'0.9': 16661, '0.8': 2066, '0.34': 69, '1.1': 690, '0.74': 965, '0.1': 28, '0.3': 73, '0.2': 55, '0.5': 186, '0.4': 108, '0.7': 615, '0.6': 303, '0.68': 549, '0.62': 352, '0.64': 394, '0.22': 51, '0.48': 140, '0.46': 112, '0.44': 115, '0.42': 102, '0.08': 36, '0.78': 1569, '0.28': 63, '0.02': 35, '0.26': 62, '0.06': 23, '0.04': 25, '0.18': 33, '0.82': 2840, '0': 33, '0.86': 5882, '0.84': 3972, '0.88': 9624, '0.14': 28, '0.16': 39, '0.76': 1279, '0.66': 486, '0.12': 34, '0.52': 202, '0.54': 215, '0.56': 224, '0.72': 754, '0.36': 85, '0.38': 80, '0.32': 70, '0.24': 57, '0.98': 140109, '0.58': 242, '0.94': 46919, '0.96': 81215, '0.92': 27823}")

# item views
# j <- jsfix("{'150': 12, '20': 274, '140': 24, '10': 376, '30': 225, '50': 314, '60': 492, '120': 90, '0': 5688, '130': 44, '110': 212, '70': 724, '90': 584, '80': 740, '40': 223, '160': 4, '100': 385}")

# item views (fixed lambda/alpha params)
# j <- jsfix("{'10': 451, '20': 114, '30': 30, '50': 4, '40': 16, '60': 3, '0': 12876}")
# j <- jsfix("{'10': 458, '20': 104, '6': 246, '30': 36, '50': 4, '40': 14, '60': 2, '3': 1320, '1': 6919, '5': 402, '4': 690, '7': 194, '70': 1, '9': 112, '2': 2732, '8': 124}")

# nbids
# j <- '{ "0": 4585, "1": 2281, "2": 2003, "3": 2026, "4": 1757, "5": 1644, "6": 1514, "7": 1423, "8": 1316, "9": 1236, "10": 8040, "20": 3655, "30": 1827, "40": 815, "50": 398, "60": 165, "70": 78, "80": 53, "90": 25, "100": 11, "110": 8, "120": 6, "130": 3, "140": 2, "150": 1, "170": 2, "180": 1, "190": 1, "210": 2, "220": 3, "250": 2, "260": 1 }'

# bid time
# j <- jsfix("{'0.9': 19807, '0.8': 2699, '0.34': 133, '1.1': 875, '0.74': 1247, '0.1': 39, '0.3': 105, '0.2': 78, '0.5': 211, '0.4': 138, '0.7': 831, '0.6': 411, '0.68': 698, '0.62': 478, '0.64': 488, '0.22': 73, '0.48': 176, '0.46': 199, '0.44': 158, '0.42': 172, '0.08': 46, '0.78': 2017, '0.28': 90, '0.02': 34, '0.26': 78, '0.06': 42, '0.04': 37, '0.18': 63, '0.82': 3470, '0': 37, '0.86': 7078, '0.84': 4850, '0.88': 11466, '0.14': 52, '0.16': 61, '0.76': 1590, '0.66': 604, '0.12': 51, '0.52': 248, '0.54': 260, '0.56': 295, '0.72': 1067, '0.36': 140, '0.38': 150, '0.32': 108, '0.24': 73, '0.98': 164736, '0.58': 331, '0.94': 56639, '0.96': 96823, '0.92': 33789}")

# bid time (w/ rnd.item(c))
# j <- jsfix("{'0.9': 5854, '0.8': 5671, '0.34': 4539, '1.1': 188192, '0.74': 5423, '0.1': 3588, '0.3': 4506, '0.2': 3995, '0.5': 5023, '0.4': 4673, '0.7': 5228, '0.6': 5239, '0.68': 5339, '0.62': 5070, '0.64': 5166, '0.22': 4048, '0.48': 4875, '0.46': 4944, '0.44': 4806, '0.42': 4838, '0.08': 3536, '0.78': 5504, '0.28': 4346, '0.02': 3434, '0.26': 4183, '0.06': 3475, '0.04': 3370, '0.18': 3839, '0.82': 5496, '0': 3791, '0.86': 5782, '0.84': 5479, '0.88': 5623, '0.14': 3784, '0.16': 4001, '0.76': 5416, '0.66': 5352, '0.12': 3719, '0.52': 4889, '0.54': 5062, '0.56': 5240, '0.72': 5223, '0.36': 4586, '0.38': 4594, '0.32': 4402, '0.24': 4129, '0.98': 5458, '0.58': 5108, '0.94': 5772, '0.96': 5701, '0.92': 5607}")

# j <- jsfix("{'0.9': 2311, '0.8': 2245, '0.34': 1672, '1.1': 96775, '0.74': 2172, '0.1': 1440, '0.3': 1665, '0.2': 1492, '0.5': 1848, '0.4': 1686, '0.7': 2206, '0.6': 2036, '0.68': 2085, '0.62': 2018, '0.64': 2048, '0.22': 1520, '0.48': 1867, '0.46': 1844, '0.44': 1832, '0.42': 1769, '0.08': 1419, '0.78': 2241, '0.28': 1578, '0.02': 1384, '0.26': 1569, '0.06': 1333, '0.04': 1276, '0.18': 1531, '0.82': 2282, '0': 1542, '0.86': 2400, '0.84': 2338, '0.88': 2448, '0.14': 1462, '0.16': 1452, '0.76': 2214, '0.66': 2035, '0.12': 1404, '0.52': 1993, '0.54': 1956, '0.56': 1966, '0.72': 2088, '0.36': 1676, '0.38': 1751, '0.32': 1648, '0.24': 1612, '0.98': 2499, '0.58': 2039, '0.94': 2453, '0.96': 2476, '0.92': 2426}")

# j <- jsfix("{'0.9': 186, '0.8': 210, '0.34': 81, '1.1': 116, '0.74': 223, '0.1': 78, '0.3': 116, '0.2': 106, '0.5': 215, '0.4': 171, '0.7': 206, '0.6': 195, '0.68': 203, '0.62': 211, '0.64': 225, '0.22': 90, '0.48': 232, '0.46': 188, '0.44': 201, '0.42': 177, '0.08': 60, '0.78': 232, '0.28': 98, '0.02': 64, '0.26': 94, '0.06': 65, '0.04': 51, '0.18': 91, '0.82': 216, '0': 68, '0.86': 195, '0.84': 203, '0.88': 218, '0.14': 84, '0.16': 96, '0.76': 205, '0.66': 227, '0.12': 65, '0.52': 239, '0.54': 210, '0.56': 238, '0.72': 206, '0.36': 111, '0.38': 150, '0.32': 100, '0.24': 117, '0.98': 165, '0.58': 199, '0.94': 233, '0.96': 198, '0.92': 216}")

# nbids_hist
# j <- '{ "0": 7210, "1": 4743, "2": 3493, "3": 2614, "4": 2074, "5": 1722, "6": 1396, "7": 1160, "8": 1075, "9": 849, "10": 4671, "20": 1522, "30": 740, "40": 400, "50": 276, "60": 198, "70": 136, "80": 110, "90": 84, "100": 65, "110": 48, "120": 48, "130": 47, "140": 36, "150": 35, "160": 24, "170": 27, "180": 20, "190": 17, "200": 21, "210": 13, "220": 10, "230": 15, "240": 8, "250": 18, "260": 10, "270": 10, "280": 4, "290": 7, "300": 10, "310": 4, "320": 4, "330": 3, "340": 11, "350": 4, "360": 4, "370": 5, "380": 5, "390": 6, "400": 4, "410": 1, "420": 4, "430": 3, "440": 4, "450": 5, "460": 1, "470": 3, "480": 2, "490": 3, "500": 3, "510": 4, "520": 2, "530": 3, "540": 1, "560": 3, "570": 2, "580": 2, "590": 1, "600": 2, "610": 2, "620": 1, "640": 3, "660": 2, "670": 2, "680": 1, "690": 1, "710": 2, "720": 1, "730": 1, "740": 1, "750": 2, "770": 1, "780": 3, "790": 2, "820": 2, "840": 2, "880": 1, "930": 1, "960": 1, "970": 1, "980": 1, "1020": 1, "1040": 1, "1050": 1, "1080": 1, "1100": 1, "1150": 1, "1240": 2, "1280": 1, "1310": 1, "1360": 1, "1370": 1, "1450": 1, "1500": 1 }'

# j <- jsfix("{'0.9': 186, '0.8': 210, '0.34': 81, '1.1': 116, '0.74': 223, '0.1': 78, '0.3': 116, '0.2': 106, '0.5': 215, '0.4': 171, '0.7': 206, '0.6': 195, '0.68': 203, '0.62': 211, '0.64': 225, '0.22': 90, '0.48': 232, '0.46': 188, '0.44': 201, '0.42': 177, '0.08': 60, '0.78': 232, '0.28': 98, '0.02': 64, '0.26': 94, '0.06': 65, '0.04': 51, '0.18': 91, '0.82': 216, '0': 68, '0.86': 195, '0.84': 203, '0.88': 218, '0.14': 84, '0.16': 96, '0.76': 205, '0.66': 227, '0.12': 65, '0.52': 239, '0.54': 210, '0.56': 238, '0.72': 206, '0.36': 111, '0.38': 150, '0.32': 100, '0.24': 117, '0.98': 165, '0.58': 199, '0.94': 233, '0.96': 198, '0.92': 216}")
# j <- jsfix("{'0.9': 196, '0.8': 229, '0.34': 149, '1.1': 59, '0.74': 201, '0.1': 83, '0.3': 110, '0.2': 95, '0.5': 179, '0.4': 139, '0.7': 224, '0.6': 208, '0.68': 194, '0.62': 179, '0.64': 194, '0.22': 109, '0.48': 124, '0.46': 152, '0.44': 147, '0.42': 160, '0.08': 98, '0.78': 185, '0.28': 123, '0.02': 84, '0.26': 116, '0.06': 87, '0.04': 68, '0.18': 112, '0.82': 212, '0': 76, '0.86': 239, '0.84': 236, '0.88': 217, '0.14': 90, '0.16': 106, '0.76': 194, '0.66': 213, '0.12': 102, '0.52': 160, '0.54': 180, '0.56': 188, '0.72': 208, '0.36': 161, '0.38': 151, '0.32': 134, '0.24': 111, '0.98': 205, '0.58': 194, '0.94': 232, '0.96': 202, '0.92': 208}")

d <- data.rubis(where="nclients = 2 ORDER BY id DESC LIMIT 1")

to.hist <- function(j) {
  l1 <- as.list(fromJSON(j))
  df1 <- data.frame(x=num(names(l1)), y=vals(l1))
  df1 <- df1[order(df1$x),]
}


bidtime.hist <- to.hist(jsfix(d$server_bid_time_hist))
save(
  ggplot(bidtime.hist, aes(x=x, weight=y))+
    geom_histogram(fill=c.blue)+
    # geom_line(aes(y=y), color=c.blue)+geom_point(aes(y=y), color=c.blue)+
    # xlab('bid')+ylab('# of bids')+
    # scale_y_continuous(labels=si.labels())+
    # scale_y_log10()+
    scale_x_continuous(breaks=c(0,0.2,0.4,0.6,0.8,1.0,1.1))+
    theme_mine
, 'test-bidtime', w=3.4, h=2.0)


nbid.hist <- to.hist(d$stat_nbids_hist)

save(
  ggplot(subset(nbid.hist, x != 0), aes(x=x, weight=y))+
    geom_histogram(fill=c.blue)+
    scale_y_log10()+
    theme_mine
, 'test-nbids', w=3.4, h=2.0)

